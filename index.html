<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --bg-body: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #e2e8f0;
            --cup-empty: #f1f5f9;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Noto Sans Arabic', sans-serif; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.6;
            padding: 20px;
        }

        .container { max-width: 950px; margin: 0 auto; }

        header { text-align: center; margin-bottom: 30px; }
        header h1 { font-size: 1.8rem; color: var(--primary); margin-bottom: 5px; }
        header p { color: var(--text-muted); font-size: 0.95rem; }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            margin-bottom: 25px;
            border: 1px solid var(--border);
        }

        .input-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 20px; 
        }

        .input-group { display: flex; flex-direction: column; gap: 8px; }
        
        .radio-group {
            display: flex;
            gap: 15px;
            background: #f1f5f9;
            padding: 8px;
            border-radius: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            flex: 1;
            justify-content: center;
            padding: 6px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        label { font-weight: 700; font-size: 0.95rem; color: var(--text-main); }
        input[type="number"] {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1.1rem;
            outline: none;
            transition: border-color 0.2s;
        }
        input:focus { border-color: var(--primary); }

        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }

        .stat-box {
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .stat-box h3 { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; }
        .stat-box div { font-size: 1.2rem; font-weight: 800; }
        .highlight { border-color: var(--primary); background: #eff6ff; }
        .highlight div { color: var(--primary); font-size: 1.5rem; }

        /* Cups Section */
        .cups-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            justify-content: space-between;
            height: 160px;
            margin: 25px 0;
        }
        .cup-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: flex-end;
        }
        .cup {
            width: 100%;
            max-width: 70px;
            height: 100px;
            border: 3px solid #cbd5e1;
            border-top: none;
            border-radius: 0 0 12px 12px;
            position: relative;
            background: var(--cup-empty);
            overflow: hidden;
            display: flex;
            align-items: flex-end;
        }
        .fill {
            width: 100%;
            background: var(--primary);
            transition: height 0.6s ease-out;
        }
        .cup-label { margin-top: 8px; font-size: 0.7rem; font-weight: 700; text-align: center; color: var(--text-main); line-height: 1.2; }

        /* Stairs Section */
        .stairs-container {
            display: flex;
            flex-direction: column-reverse;
            gap: 8px;
            margin-top: 20px;
        }
        .step {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 0.5fr;
            gap: 10px;
            padding: 12px 15px;
            background: #f1f5f9;
            border-radius: 8px;
            align-items: center;
            border-right: 5px solid #cbd5e1;
            font-size: 0.85rem;
        }
        .step.active { background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-right-color: var(--primary); }
        .step-title { font-weight: 700; }
        .step-tax { color: var(--danger); font-weight: 700; }
        .step-rate { background: #dbeafe; color: var(--primary); padding: 2px 6px; border-radius: 4px; font-weight: 700; text-align: center; }

        .egyptian-steps {
            background: #fffbeb;
            border: 1px solid #fde68a;
            border-radius: 16px;
            padding: 24px;
            margin-top: 25px;
        }
        .egyptian-steps h3 { color: #92400e; margin-bottom: 15px; }
        .egyptian-steps li { margin-bottom: 10px; font-size: 0.95rem; color: #78350f; list-style-type: '✅ '; padding-right: 5px; }

        @media (max-width: 600px) {
            .step { grid-template-columns: 1fr 1fr; text-align: center; }
            .step-rate { grid-column: span 2; }
            .cups-container { height: 120px; gap: 5px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>حاسبة الضرائب</h1>
        <p>بتحسب الوعاء وتوزعه على الشرائح عشان تعرف القرشنات راحوا فين</p>
    </header>

    <div class="card">
        <div class="input-grid">
            <!-- Salary Input -->
            <div class="input-group">
                <label>المرتب الشهري </label>
                <input type="number" id="salary" value="15000" oninput="calculate()">
            </div>

            <!-- Insurance Toggle -->
            <div class="input-group">
                <label>في تأمينات بتتخصم؟</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="insured" value="yes" checked onchange="updateUI()"> أيوه
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="insured" value="no" onchange="updateUI()"> لا
                    </label>
                </div>
            </div>

            <!-- Insurance Value -->
            <div class="input-group" id="insContainer">
                <label id="insLabel">تأمينات الموظف (شهرياً)</label>
                <input type="number" id="insurance" value="1400" oninput="calculate()">
            </div>
        </div>

        <div class="results-summary">
            <div class="stat-box">
                <h3>الوعاء الشهري</h3>
                <div id="resMonthlyTaxable">0</div>
            </div>
            <div class="stat-box">
                <h3>الوعاء السنوي</h3>
                <div id="resAnnualTaxable">0</div>
            </div>
            <div class="stat-box highlight">
                <h3>الضريبة الشهرية</h3>
                <div id="resMonthlyTax">0</div>
            </div>
            <div class="stat-box">
                <h3>الضريبة السنوية</h3>
                <div id="resAnnualTax">0</div>
            </div>
        </div>
    </div>

    <!-- Visualizers -->
    <div class="card">
        <h3 style="margin-bottom: 10px;">1. توزيع الأكواب </h3>
        <div class="cups-container" id="cups"></div>

        <h3 style="margin-top: 30px; margin-bottom: 10px;">2. سلم الشرائح </h3>
        <div class="stairs-container" id="stairs"></div>
    </div>

    <div class="egyptian-steps">
        <h3>الحسبة مشيت إزاي؟ (عالدوغري)</h3>
        <ul>
            <li>بناخد مرتبك الشهري، نشيل منه <strong>التأمينات</strong> وكمان <strong>إعفاء شخصي</strong> (1,667 جنيه).</li>
            <li>اللي بيفضل ده بنسميه "الوعاء"، بنضربه في 12 عشان نطلع "الوعاء السنوي" اللي بتتحسب عليه الضريبة.</li>
            <li>الوعاء السنوي ده بقى بنصبه في "الكوبايات" اللي فوق دي بالترتيب.. أول 40 ألف جنيه "بالصلاة علي النبي مية باردة" مفيش عليهم ضريبة.</li>
            <li>كل ما المبلغ يزيد، يخش في كباية أغلى (نسبة ضريبة أعلى).</li>
            <li>في الآخر بنجمع اللي طلع من كل الكبايات ونقسمه على 12 عشان نطلع نصيب الشهر اللي بيتخصم منك.</li>
        </ul>
    </div>
</div>

<script>
const PERSONAL_EXEMPTION_ANNUAL = 20000;
const EXEMPTION_MONTHLY = PERSONAL_EXEMPTION_ANNUAL / 12;

const brackets = [
    { limit: 40000, rate: 0, label: "معفاة" },
    { limit: 15000, rate: 0.10, label: "شريحة 10%" },
    { limit: 15000, rate: 0.15, label: "شريحة 15%" },
    { limit: 130000, rate: 0.20, label: "شريحة 20%" },
    { limit: 200000, rate: 0.225, label: "شريحة 22.5%" },
    { limit: 200000, rate: 0.25, label: "شريحة 25%" },
    { limit: 400000, rate: 0.275, label: "شريحة 27.5%" }
];

function updateUI() {
    const isInsured = document.querySelector('input[name="insured"]:checked').value === 'yes';
    document.getElementById('insContainer').style.display = isInsured ? "flex" : "none";
    calculate();
}

function calculate() {
    const insured = document.querySelector('input[name="insured"]:checked').value === 'yes';
    
    let salaryMonthly = parseFloat(document.getElementById('salary').value) || 0;
    let insuranceMonthly = insured ? (parseFloat(document.getElementById('insurance').value) || 0) : 0;

    // 1. الوعاء الشهري (بعد خصم التأمينات والإعفاء الشخصي)
    const taxableMonthly = Math.max(0, salaryMonthly - insuranceMonthly - EXEMPTION_MONTHLY);
    const taxableAnnual = taxableMonthly * 12;

    // 2. حساب الضريبة السنوية بناءً على الشرائح
    let totalTax = 0;
    let temp = taxableAnnual;
    let bracketDetails = [];

    brackets.forEach(b => {
        let amountInBracket = Math.min(temp, b.limit);
        let tax = amountInBracket * b.rate;
        bracketDetails.push({ amount: amountInBracket, tax: tax, rate: b.rate, label: b.label, limit: b.limit });
        totalTax += tax;
        temp = Math.max(0, temp - b.limit);
    });

    // 3. تعديل الدخول العالية (حسب القانون لمن يتخطى 600 ألف)
    if (taxableAnnual > 600000) {
        if (taxableAnnual <= 700000) totalTax += 4000;
        else if (taxableAnnual <= 800000) totalTax += 6750;
        else if (taxableAnnual <= 900000) totalTax += 10250;
        else if (taxableAnnual <= 1200000) totalTax += 15250;
    }

    // عرض النتائج في الخانات الملخصة
    document.getElementById('resMonthlyTaxable').innerText = taxableMonthly.toLocaleString(undefined, {maximumFractionDigits: 0}) + ' ج.م';
    document.getElementById('resAnnualTaxable').innerText = taxableAnnual.toLocaleString(undefined, {maximumFractionDigits: 0}) + ' ج.م';
    document.getElementById('resMonthlyTax').innerText = (totalTax / 12).toLocaleString(undefined, {minimumFractionDigits: 2}) + ' ج.م';
    document.getElementById('resAnnualTax').innerText = totalTax.toLocaleString(undefined, {maximumFractionDigits: 0}) + ' ج.م';

    renderVisuals(taxableAnnual, bracketDetails);
}

function renderVisuals(taxableAnnual, details) {
    // رسم الأكواب
    const cupsContainer = document.getElementById('cups');
    cupsContainer.innerHTML = '';
    details.forEach(d => {
        const fillPercent = (d.amount / d.limit) * 100;
        const cup = document.createElement('div');
        cup.className = 'cup-wrapper';
        
        // استخدام toLocaleString لتنسيق الرقم بالفواصل أسفل الكوب
        const formattedAmount = d.amount.toLocaleString(undefined, {maximumFractionDigits: 0});
        
        cup.innerHTML = `
            <div class="cup"><div class="fill" style="height: ${fillPercent}%"></div></div>
            <div class="cup-label">
                <strong>${(d.rate*100).toFixed(0)}%</strong><br>
                <span>${formattedAmount}</span>
            </div>
        `;
        cupsContainer.appendChild(cup);
    });

    // رسم السلالم التفصيلية
    const stairsContainer = document.getElementById('stairs');
    stairsContainer.innerHTML = '';
    details.forEach(d => {
        const step = document.createElement('div');
        step.className = `step ${d.amount > 0 ? 'active' : ''}`;
        step.innerHTML = `
            <div class="step-title">${d.label}</div>
            <div>المبلغ: ${d.amount.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
            <div class="step-tax">الضريبة: ${d.tax.toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
            <div class="step-rate">${(d.rate*100).toFixed(1)}%</div>
        `;
        stairsContainer.appendChild(step);
    });
}

// تشغيل الحسابات لأول مرة عند تحميل الصفحة
calculate();
</script>

</body>
</html>
